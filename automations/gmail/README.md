# Gmail Authentication

Simple Gmail API authentication that generates credentials for use in Windmill workflows and other scripts.

### Step 1: Setup Google Console OAuth

Follow the detailed OAuth setup guide to create your Gmail API credentials:

**ðŸ“‹ See: [OAuth Setup Guide](../existential/README_windmill.md#oauth-setup)**

This will guide you through:

- Creating a Google Cloud Project
- Enabling the Gmail API
- Setting up OAuth 2.0 credentials
- Downloading your `credentials.json` file

Place the downloaded `credentials.json` file in this directory (`/automations/gmail/`).

### Step 2: Run Authentication Script

Choose your platform and run the authentication script to generate your token:

**Windows (Git Bash/PowerShell):**

```bash
# Navigate to directory
cd ./automations/gmail

# Create and activate virtual environment
python3 -m venv .venv
source .venv/Scripts/activate  # Git Bash
# .venv\Scripts\Activate.ps1   # PowerShell

# Install dependencies and run
pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
python gmail_authentication.py
```

**Linux/macOS (Using Makefile):**

```bash
make setup
make run
```

This will open a browser window for OAuth consent and create `token.json` upon successful authentication.

### Step 3: Add Credentials to Windmill

Once you have the `token.json` file, add it as a resource in Windmill:

1. **Log into your Windmill instance**
2. **Go to Resources â†’ Add resource**
3. **Search for and create a "gmail" resource:**
4. **Toggle the "As JSON" switch on**
5. **Paste the entire token.json file contents**
6. **Save**
7. **Usage in Windmill scripts:**

```
import { google } from 'googleapis';

type Gmail = { token: string };

async function getGmailService(gmail: Gmail) {
  try {
    if (!gmail.token) {
      throw new Error('No Gmail token. Select Gmail resource in args.');
    }

    const oauth2Client = new google.auth.OAuth2();
    oauth2Client.setCredentials({ access_token: gmail.token });

    const service = google.gmail({ version: 'v1', auth: oauth2Client });
    await service.users.labels.list({ userId: 'me' }); // Validity check
    return service;
  } catch (error) {
    console.error('Auth error:', error);
    throw new Error(`Auth failed: ${error.message}. Re-connect Gmail resource.`);
  }
}

export async function main(gmail: Gmail): Promise<string> {
   let service: any;
   service = await getGmailService(gmail);
   ...
}
```

## Files Generated

- `token.json` - Access/refresh tokens (generated by authentication script) used in Windmill
